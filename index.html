<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>./ GRAD DODGE </title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Press Start 2P', monospace;
      height: 100vh;
      overflow: hidden;
      background: #0a0a0a;
      color: #00ff41;
      position: relative;
    }

    #bg-grid {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      font-size: 12px;
      line-height: 16px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 1;
      white-space: pre;
      font-family: 'Courier New', monospace;
      user-select: none;
    }

    #menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 40px;
      text-shadow: 0 0 10px #00ff41;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 10px #00ff41; }
      to { text-shadow: 0 0 20px #00ff41, 0 0 30px #00ff41; }
    }

    .btn {
      background: #00ff41;
      color: #000;
      border: none;
      padding: 18px 36px;
      font-family: 'Press Start 2P', monospace;
      font-size: 16px;
      cursor: pointer;
      margin: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
      transition: all 0.3s;
      user-select: none;
    }

    .btn:hover {
      background: #00cc33;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.8);
      transform: scale(1.05);
    }

    .btn-small {
      padding: 10px 20px;
      font-size: 12px;
      margin: 6px;
    }

    .btn-diff-active {
      background: #00ccff;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.8);
    }

    #gameCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      image-rendering: pixelated;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      z-index: 5;
    }

    #ui {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 15;
      font-size: 18px;
      text-shadow: 0 0 5px #00ff41;
      user-select: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #ui span {
      margin-right: 16px;
    }

    #gameOver {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 4px solid #ff0040;
      padding: 50px;
      text-align: center;
      display: none;
      z-index: 20;
      box-shadow: 0 0 40px rgba(255, 0, 64, 0.5);
      user-select: none;
    }

    #finalScore {
      font-size: 24px;
      margin: 18px 0;
      color: #ff0040;
      text-shadow: 0 0 10px #ff0040;
    }

    #finalBest {
      font-size: 18px;
      margin-bottom: 10px;
      color: #ccc;
    }

    #powerupInfo {
      font-size: 12px;
      margin-top: 18px;
      line-height: 1.7;
      color: #ccc;
    }

    #bestBlock {
      font-size: 12px;
      margin-top: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div id="bg-grid"></div>

  <div id="ui">
    <span id="time">TIME: 60s</span> |
    <span id="score">SCORE: 0</span> |
    <span id="shield">SHIELD: OFF</span> |
    <span id="slowmo">SLOWMO: OFF</span> |
    <span id="diffLabel">DIFF: EASY</span>
  </div>

  <div id="menu">
    <h1>./ DODGE</h1>
    <p>– Dodge X enemies!</p>
    <p>– Collect + for +10 points!</p>
    <p>– Collect * for SHIELD (1 hit)!</p>
    <p>– Collect S to SLOW TIME!</p>
    <p>– Survive 60 seconds!</p>
    <br />

    <div id="difficultyButtons">
      <button class="btn btn-small btn-diff-active" data-diff="easy">EASY</button>
      <button class="btn btn-small" data-diff="normal">NORMAL</button>
      <button class="btn btn-small" data-diff="hard">HARD</button>
    </div>

    <br/>
    <button class="btn" id="startBtn">./ START GAME</button>

    <div id="bestBlock">
      BEST EASY: <span id="bestEasy">0</span> |
      BEST NORMAL: <span id="bestNormal">0</span> |
      BEST HARD: <span id="bestHard">0</span>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="gameOver">
    <h2>./ GAME OVER</h2>
    <div id="finalScore">FINAL SCORE: 0</div>
    <div id="finalBest">BEST (MODE): 0</div>
    <button class="btn" id="restartBtn">./ RESTART</button>
    <br /><br />
    <button class="btn" id="menuBtn" style="background: #666;">./ MAIN MENU</button>
  </div>

  <script>
    function createBgGrid() {
      const grid = document.getElementById('bg-grid');
      let content = '';
      const cols = Math.floor(window.innerWidth / 14);
      const rows = Math.floor(window.innerHeight / 16);

      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          content += './';
        }
        content += '\n';
      }
      grid.textContent = content;
    }

    createBgGrid();
    window.addEventListener('resize', createBgGrid);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    ctx.imageSmoothingEnabled = false;

    const GLOBAL_GAME_TIME = 60000;

    const difficulties = {
      easy: {
        label: 'EASY',
        enemySpawnBase: 0.055,
        enemySpeedBase: { min: 1.6, max: 3.1 },
        plusChance: 0.03,
        shieldChance: 0.012,
        slowmoChance: 0.012
      },
      normal: {
        label: 'NORMAL',
        enemySpawnBase: 0.07,
        enemySpeedBase: { min: 2.1, max: 4.6 },
        plusChance: 0.018,
        shieldChance: 0.007,
        slowmoChance: 0.007
      },
      hard: {
        label: 'HARD',
        enemySpawnBase: 0.09,
        enemySpeedBase: { min: 2.7, max: 5.7 },
        plusChance: 0.015,   
        shieldChance: 0.002, 
        slowmoChance: 0.002
      }
    };

    let currentDifficultyKey = 'easy';
    let GAME_TIME = GLOBAL_GAME_TIME;
    let enemySpawnBase = difficulties[currentDifficultyKey].enemySpawnBase;
    let enemySpeedBase = {...difficulties[currentDifficultyKey].enemySpeedBase};
    let plusChance = difficulties[currentDifficultyKey].plusChance;
    let shieldChance = difficulties[currentDifficultyKey].shieldChance;
    let slowmoChance = difficulties[currentDifficultyKey].slowmoChance;

    const HS_KEY = 'dodgePlusHighscores_v1';
    let highscores = loadHighscores();
    updateBestBlock();

    function loadHighscores() {
      try {
        const raw = localStorage.getItem(HS_KEY);
        if (!raw) {
          return { easy: 0, normal: 0, hard: 0 };
        }
        const parsed = JSON.parse(raw);
        return {
          easy: parsed.easy || 0,
          normal: parsed.normal || 0,
          hard: parsed.hard || 0
        };
      } catch (e) {
        return { easy: 0, normal: 0, hard: 0 };
      }
    }

    function saveHighscores() {
      try {
        localStorage.setItem(HS_KEY, JSON.stringify(highscores));
      } catch (e) {
      }
    }

    function updateBestBlock() {
      document.getElementById('bestEasy').textContent = highscores.easy;
      document.getElementById('bestNormal').textContent = highscores.normal;
      document.getElementById('bestHard').textContent = highscores.hard;
    }

    function tryUpdateHighscore(modeKey, score) {
      if (score > (highscores[modeKey] || 0)) {
        highscores[modeKey] = score;
        saveHighscores();
        updateBestBlock();
        return true;
      }
      return false;
    }

    const diffButtonsContainer = document.getElementById('difficultyButtons');
    diffButtonsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-diff]');
      if (!btn) return;

      const diff = btn.getAttribute('data-diff');
      if (!difficulties[diff]) return;

      currentDifficultyKey = diff;
      const config = difficulties[diff];

      enemySpawnBase = config.enemySpawnBase;
      enemySpeedBase = {...config.enemySpeedBase};
      plusChance = config.plusChance;
      shieldChance = config.shieldChance;
      slowmoChance = config.slowmoChance;

      [...diffButtonsContainer.querySelectorAll('button')].forEach(b => {
        b.classList.remove('btn-diff-active');
      });
      btn.classList.add('btn-diff-active');

      const diffLabel = document.getElementById('diffLabel');
      if (diffLabel) {
        diffLabel.textContent = `DIFF: ${config.label}`;
      }
    });

    let gameRunning = false;
    const PLAYER_SIZE = 28;
    const FONT = 'bold 26px monospace';
    let player = { x: window.innerWidth / 2, y: window.innerHeight - 100, size: PLAYER_SIZE };

    let enemies = [];
    let collectibles = [];    
    let shieldPowerups = [];  
    let slowmoPowerups = [];  

    let score = 0;
    let startTime = 0;

    let shieldActive = false;
    let slowmoActive = false;
    let slowmoEndTime = 0;

    const keys = {};
    document.addEventListener('keydown', (e) => {
      keys[e.code] = true;
      if (e.code === 'Space' && !gameRunning) e.preventDefault();
    });
    document.addEventListener('keyup', (e) => {
      keys[e.code] = false;
    });

    function createEnemy(difficultyFactor = 1) {
      const speed = enemySpeedBase.min + Math.random() * (enemySpeedBase.max - enemySpeedBase.min) * difficultyFactor;
      return {
        x: Math.random() * (canvas.width - PLAYER_SIZE) + PLAYER_SIZE / 2,
        y: -PLAYER_SIZE,
        size: PLAYER_SIZE,
        speed
      };
    }

    function createCollectible() {
      return {
        type: '+',
        x: Math.random() * (canvas.width - PLAYER_SIZE) + PLAYER_SIZE / 2,
        y: -PLAYER_SIZE,
        size: PLAYER_SIZE,
        speed: 1.5 + Math.random() * 1.5
      };
    }

    function createShieldPowerup() {
      return {
        type: '*',
        x: Math.random() * (canvas.width - PLAYER_SIZE) + PLAYER_SIZE / 2,
        y: -PLAYER_SIZE,
        size: PLAYER_SIZE,
        speed: 1.3 + Math.random() * 1.2
      };
    }

    function createSlowmoPowerup() {
      return {
        type: 'S',
        x: Math.random() * (canvas.width - PLAYER_SIZE) + PLAYER_SIZE / 2,
        y: -PLAYER_SIZE,
        size: PLAYER_SIZE,
        speed: 1.2 + Math.random() * 1.1
      };
    }

    function collided(obj1, obj2) {
      const dx = obj1.x - obj2.x;
      const dy = obj1.y - obj2.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      return dist < (obj1.size / 2 + obj2.size / 2) * 0.9;
    }

    function clampPlayer() {
      player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
      player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));
    }

    function activateShield() {
      shieldActive = true;
      document.getElementById('shield').textContent = 'SHIELD: ON';
    }

    function deactivateShield() {
      shieldActive = false;
      document.getElementById('shield').textContent = 'SHIELD: OFF';
    }

    function activateSlowmo(durationMs) {
      slowmoActive = true;
      slowmoEndTime = Date.now() + durationMs;
      document.getElementById('slowmo').textContent = 'SLOWMO: ON';
    }

    function updateSlowmo() {
      if (slowmoActive && Date.now() >= slowmoEndTime) {
        slowmoActive = false;
        document.getElementById('slowmo').textContent = 'SLOWMO: OFF';
      }
    }

    function update() {
      if (!gameRunning) return;

      const baseSpeed = 8;
      const moveSpeed = slowmoActive ? baseSpeed * 0.7 : baseSpeed;
      if (keys['ArrowLeft'] || keys['KeyA']) player.x -= moveSpeed;
      if (keys['ArrowRight'] || keys['KeyD']) player.x += moveSpeed;
      if (keys['ArrowUp'] || keys['KeyW']) player.y -= moveSpeed;
      if (keys['ArrowDown'] || keys['KeyS']) player.y += moveSpeed;

      clampPlayer();

      const elapsed = Date.now() - startTime;
      const timeFactor = Math.min(1.8, 1 + elapsed / GAME_TIME);
      const slowFactor = slowmoActive ? 0.4 : 1;

      enemies.forEach(enemy => enemy.y += enemy.speed * slowFactor);
      collectibles.forEach(c => c.y += c.speed * slowFactor);
      shieldPowerups.forEach(p => p.y += p.speed * slowFactor);
      slowmoPowerups.forEach(p => p.y += p.speed * slowFactor);

      const limit = canvas.height + 40;
      enemies = enemies.filter(e => e.y < limit);
      collectibles = collectibles.filter(c => c.y < limit);
      shieldPowerups = shieldPowerups.filter(p => p.y < limit);
      slowmoPowerups = slowmoPowerups.filter(p => p.y < limit);

      const enemySpawnChance = enemySpawnBase * timeFactor;
      if (Math.random() < enemySpawnChance) enemies.push(createEnemy(timeFactor));

      if (Math.random() < plusChance) collectibles.push(createCollectible());
      if (Math.random() < shieldChance) shieldPowerups.push(createShieldPowerup());
      if (Math.random() < slowmoChance) slowmoPowerups.push(createSlowmoPowerup());

      for (let i = enemies.length - 1; i >= 0; i--) {
        if (collided(player, enemies[i])) {
          if (shieldActive) {
            enemies.splice(i, 1);
            deactivateShield();
          } else {
            gameOver();
            return;
          }
        }
      }

      for (let i = collectibles.length - 1; i >= 0; i--) {
        if (collided(player, collectibles[i])) {
          score += 10;
          collectibles.splice(i, 1);
        }
      }

      for (let i = shieldPowerups.length - 1; i >= 0; i--) {
        if (collided(player, shieldPowerups[i])) {
          activateShield();
          shieldPowerups.splice(i, 1);
        }
      }

      for (let i = slowmoPowerups.length - 1; i >= 0; i--) {
        if (collided(player, slowmoPowerups[i])) {
          activateSlowmo(4000);
          slowmoPowerups.splice(i, 1);
        }
      }

      updateSlowmo();

      document.getElementById('score').textContent = `SCORE: ${score}`;
      const timeLeft = Math.max(0, GAME_TIME - elapsed);
      document.getElementById('time').textContent = `TIME: ${Math.floor(timeLeft / 1000)}s`;

      if (elapsed >= GAME_TIME) {
        gameWin();
      }
    }

    // ---------- DRAW ----------
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.font = FONT;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      if (shieldActive) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
        ctx.strokeStyle = '#00bfff';
        ctx.lineWidth = 3;
        ctx.shadowColor = '#00bfff';
        ctx.shadowBlur = 15;
        ctx.stroke();
        ctx.restore();
      }

      ctx.fillStyle = '#00ff41';
      ctx.shadowColor = '#00ff41';
      ctx.shadowBlur = 12;
      ctx.fillText('./', player.x, player.y);
      ctx.shadowBlur = 0;

      enemies.forEach(enemy => {
        ctx.fillStyle = '#ff0040';
        ctx.shadowColor = '#ff0040';
        ctx.shadowBlur = 12;
        ctx.fillText('X', enemy.x, enemy.y);
        ctx.shadowBlur = 0;
      });

      collectibles.forEach(c => {
        ctx.fillStyle = '#bb00ff';
        ctx.shadowColor = '#bb00ff';
        ctx.shadowBlur = 12;
        ctx.fillText('+', c.x, c.y);
        ctx.shadowBlur = 0;
      });

      shieldPowerups.forEach(p => {
        ctx.fillStyle = '#00bfff';
        ctx.shadowColor = '#00bfff';
        ctx.shadowBlur = 12;
        ctx.fillText('*', p.x, p.y);
        ctx.shadowBlur = 0;
      });

      slowmoPowerups.forEach(p => {
        ctx.fillStyle = '#ffff00';
        ctx.shadowColor = '#ffff00';
        ctx.shadowBlur = 12;
        ctx.fillText('S', p.x, p.y);
        ctx.shadowBlur = 0;
      });
    }

    // ---------- MAIN LOOP ----------
    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // ---------- GAME FLOW ----------
    function startGame() {
      const config = difficulties[currentDifficultyKey];

      GAME_TIME = GLOBAL_GAME_TIME;
      enemySpawnBase = config.enemySpawnBase;
      enemySpeedBase = {...config.enemySpeedBase};
      plusChance = config.plusChance;
      shieldChance = config.shieldChance;
      slowmoChance = config.slowmoChance;

      gameRunning = true;
      startTime = Date.now();
      score = 0;

      player.x = canvas.width / 2;
      player.y = canvas.height - 100;

      enemies = [];
      collectibles = [];
      shieldPowerups = [];
      slowmoPowerups = [];

      shieldActive = false;
      slowmoActive = false;
      document.getElementById('shield').textContent = 'SHIELD: OFF';
      document.getElementById('slowmo').textContent = 'SLOWMO: OFF';
      document.getElementById('diffLabel').textContent = `DIFF: ${config.label}`;
      document.getElementById('time').textContent = 'TIME: 60s';
      document.getElementById('score').textContent = 'SCORE: 0';

      document.getElementById('menu').style.display = 'none';
      document.getElementById('gameOver').style.display = 'none';
      canvas.style.display = 'block';
      ui.style.opacity = '1';
    }

    function showMenu() {
      canvas.style.display = 'none';
      document.getElementById('gameOver').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
      ui.style.opacity = '0';
    }

    function endGameCommon(title) {
      gameRunning = false;

      const isNewBest = tryUpdateHighscore(currentDifficultyKey, score);
      const bestForMode = highscores[currentDifficultyKey] || 0;
      const label = difficulties[currentDifficultyKey].label;

      const finalScoreEl = document.getElementById('finalScore');
      const finalBestEl = document.getElementById('finalBest');

      finalScoreEl.textContent = `FINAL SCORE: ${score}`;
      finalBestEl.textContent = `BEST ${label}: ${bestForMode}` + (isNewBest ? '  (NEW!)' : '');

      showGameOver(
        title === './ YOU WIN!' ? '#00ff41' : '#ff0040',
        title === './ YOU WIN!' ? 'rgba(0, 255, 65, 0.5)' : 'rgba(255, 0, 64, 0.5)',
        title
      );
    }

    function gameOver() {
      endGameCommon('./ GAME OVER');
    }

    function gameWin() {
      endGameCommon('./ YOU WIN!');
    }

    function showGameOver(borderColor, shadowColor, title) {
      const go = document.getElementById('gameOver');
      go.style.borderColor = borderColor;
      go.style.boxShadow = `0 0 40px ${shadowColor}`;
      go.querySelector('h2').textContent = title;
      go.style.display = 'block';
      bindGameOverButtons();
    }

    function bindGameOverButtons() {
      document.getElementById('restartBtn').onclick = () => {
        document.getElementById('gameOver').style.display = 'none';
        startGame();
      };
      document.getElementById('menuBtn').onclick = () => {
        document.getElementById('gameOver').style.display = 'none';
        showMenu();
      };
    }

    document.getElementById('startBtn').onclick = startGame;

    gameLoop();
  </script>
</body>
</html>
